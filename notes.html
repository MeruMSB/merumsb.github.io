<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mudae Tool: Re-note your harem</title>

        <link rel="stylesheet" href="style.css">
        <style type="text/css">
            .note-list {
                max-width: 800px;
                margin: 0 auto;
            }
            .note-list .notes-total {
                padding: 0 10px;
                margin: 30px auto 20px;
                font-size: 20px;
            }
            .note-list .notes-title {
                padding: 0 10px;
                margin: 20px auto 10px;
            }
            .note-list .command-box {
                background:#2B2D31;
                border-radius: 5px;
                padding: 10px;
                margin: 10px auto;
            }
            .copy-status {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .command-title {
                padding: 0 8px;
                width: 100%;
                text-align: left;
            }
            .note-list .status {
                display: inline-block;
                background: #222;
                border: 1px solid #999;
                flex: 0 0 30px;
                height: 30px;
                line-height: 30px;
                border-radius: 50%;
                text-align: center;
                font-size: 22px;
                position: relative;
            }
            .note-list .status.active {
                background: #256425;
            }
            .note-list .status.active:before {
                content: "";
                position: absolute;
                top: 12px;
                left: 6px;
                width: 4px;
                height: 13px;
                background: white;
                transform: rotate(-55deg);
            }
            .note-list .status.active:after {
                content: "";
                position: absolute;
                top: 4px;
                left: 15px;
                width: 4px;
                height: 20px;
                background: white;
                transform: rotate(35deg);
            }
            .command-txt {
                margin-top: 10px;
                line-height: 1.4;
                font-family: monospace;
                font-size: 12px;
                color: #e28764;
            }
            .command-txt .command {
                color: #ca5479;
            }
            .command-txt .separator {
                color: #79c59f;
            }
            .command-txt .important {
                color: #93b6eb;
            }
        </style>
    </head>
    <body>

        <div class="admin">
            <textarea id="textarea" class="textarea" rows="1" placeholder="[$mms / $mmsn+] Paste the command result"></textarea>
            <button id="btn" class="button" type="button">Confirm</button>
            <label class="button-label">
                <input type="checkbox" id="nitro"/>
                <div class="button">I have Nitro</div>
            </label>
        </div>
        <ul id="note_list" class="note-list"></ul>
        
        <div id="alert" class="alert">
            <button id="alert_close" class="alert-close" type="button">âœ–</button>
            <div id="alert_content"></div>
        </div>
        <div class="fixed">Like my tool? Support my favourite character: <button id="vote_my_fave" class="button" type="button">$ly Nosepass</button></div>
        
        <script src="general.js"></script>
        <script type="text/javascript">
            const textarea = document.getElementById("textarea");
            const nitro = document.getElementById("nitro");
            const list = document.getElementById("note_list");
            const character_limit = 1900;
            
            document.getElementById("btn").addEventListener("click",function(e){
                e.preventDefault();

                let textarea_value = textarea.value;
                let command_limit = character_limit * (nitro.checked?2:1);

                textarea.value = "";
                list.innerHTML = "";

                let command_re = new RegExp(/^\$[a-zA-Z]\S+/);
                let command_detected = textarea_value.match(command_re);
                if(command_detected) {
                    show_alert(5000, "<strong>"+command_detected[0]+"</strong> detected!<br/><br/>You need to send the command in your Mudae channel, then copy the result Mudae sent you via DM and paste it into the tool.");
                }

                let re = new RegExp(/ \| /, "g");
                textarea_value = textarea_value.split(/\r?\n|\r|\n/g)
                    .filter(s => s.match(re))
                    .map(s => {
                        let parts = s.split(re);

                        return {
                            name: parts[0],
                            note: parts[1]
                        };
                    });

                let notes = {},
                    pages = {};
                for(let character of textarea_value) {
                    if(typeof pages[character.note]=="undefined") {
                        notes[character.note] = [[]];
                        pages[character.note] = 0;
                    }

                    let note_list = notes[character.note][pages[character.note]];
                    if((note_list.join("$").length + character.note.length + 4)>command_limit) {
                        pages[character.note]++;
                        notes[character.note].push([]);
                    }
                    
                    notes[character.note][pages[character.note]].push(character.name);
                }

                if(Object.values(notes).length<0) {
                    return false;
                }

                let notes_count = Object.values(notes).reduce((obj, item) => obj.concat(item)).length;
                let notes_total = document.createElement("li");
                    notes_total.classList.add("notes-total");
                    notes_total.innerText = notes_count+" commands:";
                
                list.appendChild(notes_total);

                for(let note in notes) {
                    let note_list = notes[note];

                    let notes_title = document.createElement("li");
                        notes_title.classList.add("notes-title");
                        notes_title.innerText = note;
                    list.appendChild(notes_title);

                    for(let i=0;i<note_list.length;i++) {
                        note_list[i].push("");
                        let command_txt = "$n "+ note_list[i].join("$")+note;
                        let command_txt_html = '<span class="command">$n</span> '+ note_list[i].join('<span class="separator">$</span>')+'<span class="important">'+note+'</span>';

                        create_command(command_txt, command_txt_html);
                    }
                }

                let notes_extra = document.createElement("li");
                    notes_extra.classList.add("notes-total");
                    notes_extra.innerText = "Extra commands to beautify your harem:";
                
                list.appendChild(notes_extra);

                create_command("$sm abc", '<span class="command">$sm</span> <span class="important">abc</span>', "Sort alphabetically");

                let sort_note = "$sm note "+Object.keys(notes).join("$");
                let sort_note_html = '<span class="command">$sm</span> <span class="important">note</span> '+Object.keys(notes).join('<span class="separator">$</span>');
                create_command(sort_note, sort_note_html, "Sort by notes");

                function create_command(txt, html, command_title) {
                    let li = document.createElement("li");
                        li.classList.add("command-box");
                    let copy_box = document.createElement("div");
                        copy_box.classList.add("copy-status");
                    let btn = document.createElement("button");
                        btn.setAttribute("type", "button");
                        btn.classList.add("button");
                        btn.innerText = "Copy";
                    let title = document.createElement("div");
                        title.classList.add("command-title");
                        title.innerText = typeof command_title != "undefined" ? command_title : "";
                    let status = document.createElement("div");
                        status.classList.add("status");
                        
                    copy_box.appendChild(btn);
                    copy_box.appendChild(title);
                    copy_box.appendChild(status);
                        
                    let command_txt = document.createElement("div");
                        command_txt.classList.add("command-txt");
                        command_txt.innerHTML = html;

                    li.appendChild(copy_box);
                    li.appendChild(command_txt);

                    list.appendChild(li);

                    btn.addEventListener("click", function() {
                        navigator.clipboard.writeText(txt);
                        show_alert(2500, "<strong>$note</strong> command copied!");

                        btn.classList.add("active");
                        btn.innerText = "Copied";
                        status.classList.add("active");
                        li.style = "opacity:.7";
                    });
                }
            });
        </script>
    </body>
</html>